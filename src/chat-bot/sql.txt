-- Удаляем старую таблицу если осталась
DROP TABLE IF EXISTS chatbot_knowledge CASCADE;

-- Создаём новую таблицу
CREATE TABLE chatbot_knowledge (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  category TEXT NOT NULL,
  question_ru TEXT NOT NULL,
  answer_ru TEXT NOT NULL,
  question_kz TEXT NOT NULL,
  answer_kz TEXT NOT NULL,
  keywords TEXT[] NOT NULL, -- ключевые слова на обоих языках
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Индексы для быстрого поиска
CREATE INDEX idx_chatbot_keywords ON chatbot_knowledge USING GIN(keywords);
CREATE INDEX idx_chatbot_category ON chatbot_knowledge(category);

-- Отключаем RLS для публичного доступа
ALTER TABLE chatbot_knowledge DISABLE ROW LEVEL SECURITY;

-- Функция обновления времени
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_chatbot_knowledge_updated_at
  BEFORE UPDATE ON chatbot_knowledge
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ========================================
-- ЗАПОЛНЕНИЕ БАЗЫ ЗНАНИЙ
-- ========================================

-- Категория: Общая информация
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('general', 
 'Что это за центр?',
 'Это КГП на ПХВ "Областной реабилитационный центр" - государственное медицинское учреждение, специализирующееся на профессиональной реабилитации детей с различными заболеваниями и нарушениями развития.',
 'Бұл қандай орталық?',
 'Бұл ШЖҚ ҚПК "Облыстық оңалту орталығы" - балалардың әртүрлі аурулары мен даму бұзылыстарын кәсіби оңалтуға маманданған мемлекеттік медициналық мекеме.',
 ARRAY['центр', 'орталық', 'кгп', 'шжқ', 'областной', 'облыстық', 'реабилитация', 'оңалту', 'что', 'қандай', 'это', 'бұл']),

('general',
 'Сколько лет работает центр?',
 'Центр работает более 25 лет, оказывая качественную медицинскую помощь детям Павлодарской области.',
 'Орталық қанша жыл жұмыс істейді?',
 'Орталық 25 жылдан астам уақыт бойы Павлодар облысының балаларына сапалы медициналық көмек көрсетіп келеді.',
 ARRAY['лет', 'жыл', 'работа', 'жұмыс', 'история', 'тарих', 'опыт', 'тәжірибе', 'давно', 'ұзақ']),

('general',
 'Какой график работы?',
 'Центр работает с понедельника по пятницу с 08:00 до 17:00. Обеденный перерыв с 12:00 до 13:00. Суббота и воскресенье - выходные.',
 'Жұмыс кестесі қандай?',
 'Орталық дүйсенбіден жұмаға дейін 08:00-ден 17:00-ге дейін жұмыс істейді. Түскі үзіліс 12:00-ден 13:00-ге дейін. Сенбі және жексенбі - демалыс.',
 ARRAY['график', 'кесте', 'работа', 'жұмыс', 'время', 'уақыт', 'часы', 'сағат', 'расписание', 'когда', 'қашан', 'открыт']),

('general',
 'Где находится центр?',
 'Центр расположен по адресу: г. Павлодар, ул. Академика Сатпаева, 72. Рядом с парком им. Жусупова. Точное местоположение можно найти в разделе "Контакты" на сайте.',
 'Орталық қайда орналасқан?',
 'Орталық мына мекенжайда орналасқан: Павлодар қ., Академик Сәтпаев көшесі, 72. Жүсіпов атындағы саябақтың жанында. Нақты орналасуды сайттың "Байланыс" бөлімінен табуға болады.',
 ARRAY['адрес', 'мекенжай', 'где', 'қайда', 'находится', 'орналасқан', 'местоположение', 'орын', 'расположение', 'павлодар']);

-- Категория: Услуги
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('services',
 'Какие услуги вы предоставляете?',
 'Мы предоставляем комплексную реабилитацию для детей, включая: физиотерапию и ЛФК, логопедическую помощь, психологическую поддержку, массаж и мануальную терапию, медикаментозное лечение, диагностику развития.',
 'Қандай қызметтер көрсетесіз?',
 'Біз балаларға кешенді оңалту қызметін көрсетеміз: физиотерапия және ЕДШ, логопедиялық көмек, психологиялық қолдау, массаж және мануалды терапия, медикаменттік ем, даму диагностикасы.',
 ARRAY['услуги', 'қызметтер', 'қызмет', 'реабилитация', 'оңалту', 'помощь', 'көмек', 'лечение', 'ем', 'что', 'не', 'қандай', 'делаете', 'предоставляете', 'көрсетесіз']),

('services',
 'Есть ли физиотерапия?',
 'Да, в центре есть современный физиотерапевтический кабинет с оборудованием для проведения различных процедур: электрофорез, магнитотерапия, УВЧ, лазеротерапия, ультразвуковая терапия и другие.',
 'Физиотерапия бар ма?',
 'Иә, орталықта әртүрлі процедураларды жүргізуге арналған жабдықтары бар заманауи физиотерапиялық кабинет бар: электрофорез, магниттік терапия, ДЖТ, лазерлік терапия, ультрадыбыстық терапия және т.б.',
 ARRAY['физиотерапия', 'физиотерапия', 'физио', 'процедуры', 'процедуралар', 'оборудование', 'жабдық', 'электрофорез', 'увч', 'джт', 'бар', 'есть']),

('services',
 'Работает ли логопед?',
 'Да, в центре работают квалифицированные логопеды-дефектологи, которые помогают детям с нарушениями речи, дислалией, дизартрией, заиканием, задержкой речевого развития.',
 'Логопед жұмыс істейді ме?',
 'Иә, орталықта сөйлеу бұзылыстары, дислалия, дизартрия, кекештік, сөйлеудің кешігуі бар балаларға көмектесетін білікті логопед-дефектологтар жұмыс істейді.',
 ARRAY['логопед', 'логопед', 'речь', 'сөйлеу', 'говорить', 'айту', 'заикание', 'кекештік', 'дислалия', 'задержка', 'кешігу', 'работает', 'істейді']),

('services',
 'Есть ли психолог?',
 'Да, с детьми и их родителями работают детские психологи. Проводятся индивидуальные и групповые занятия, консультации, арт-терапия, игровая терапия.',
 'Психолог бар ма?',
 'Иә, балалармен және олардың ата-аналарымен балалар психологтары жұмыс істейді. Жеке және топтық сабақтар, консультациялар, арт-терапия, ойын терапиясы өткізіледі.',
 ARRAY['психолог', 'психолог', 'психология', 'психология', 'консультация', 'консультация', 'поддержка', 'қолдау', 'терапия', 'бар', 'есть']),

('services',
 'Делаете ли массаж?',
 'Да, в центре проводится лечебный массаж для детей с неврологическими заболеваниями, ДЦП, нарушениями опорно-двигательного аппарата. Массаж выполняют сертифицированные специалисты с большим опытом работы.',
 'Массаж жасайсыздар ма?',
 'Иә, орталықта неврологиялық аурулары, БЦС, тірек-қимыл аппараты бұзылыстары бар балаларға емдік массаж жасалады. Массажды үлкен жұмыс тәжірибесі бар сертификатталған мамандар орындайды.',
 ARRAY['массаж', 'массаж', 'лечебный', 'емдік', 'детский', 'балалар', 'дцп', 'бцс', 'неврология', 'неврология', 'делаете', 'жасайсыздар']),

('services',
 'Что такое ЛФК?',
 'ЛФК (лечебная физкультура) - это специальные упражнения для восстановления двигательных функций, укрепления мышц, улучшения координации и общего физического развития ребёнка. Занятия проводятся индивидуально или в небольших группах.',
 'ЕДШ дегеніміз не?',
 'ЕДШ (емдік дене шынықтыру) - бұл қозғалыс функцияларын қалпына келтіру, бұлшықеттерді нығайту, үйлестіруді жақсарту және баланың жалпы физикалық дамуы үшін арнайы жаттығулар. Сабақтар жеке немесе шағын топтарда өткізіледі.',
 ARRAY['лфк', 'едш', 'физкультура', 'дене', 'шынықтыру', 'упражнения', 'жаттығулар', 'гимнастика', 'гимнастика', 'занятия', 'сабақтар', 'что', 'не', 'такое', 'дегеніміз']);

-- Категория: Контакты и запись
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('contacts',
 'Как записаться на приём?',
 'Записаться можно несколькими способами: 1) По телефону: +7 (7182) 55-44-33, 2) Через форму на сайте в разделе "Контакты", 3) Лично в регистратуре центра в рабочие часы.',
 'Қабылдауға қалай жазылуға болады?',
 'Жазылудың бірнеше жолы бар: 1) Телефон арқылы: +7 (7182) 55-44-33, 2) Сайттың "Байланыс" бөлімінде форма арқылы, 3) Жұмыс уақытында орталықтың тіркеу бөлімінде жеке.',
 ARRAY['запись', 'жазылу', 'записаться', 'жазылуға', 'приём', 'қабылдау', 'как', 'қалай', 'попасть', 'регистратура', 'тіркеу']),

('contacts',
 'Какой номер телефона?',
 'Телефон центра: +7 (7182) 55-44-33. Звонить можно с понедельника по пятницу с 08:00 до 17:00 (перерыв 12:00-13:00).',
 'Телефон номері қандай?',
 'Орталықтың телефоны: +7 (7182) 55-44-33. Дүйсенбіден жұмаға дейін 08:00-ден 17:00-ге дейін (үзіліс 12:00-13:00) телефон шалуға болады.',
 ARRAY['телефон', 'телефон', 'номер', 'номер', 'позвонить', 'шалу', 'связаться', 'хабарласу', 'контакт', 'байланыс']),

('contacts',
 'Есть ли электронная почта?',
 'Да, email центра: rehabilcenter@mail.kz. По всем вопросам можете писать на эту почту.',
 'Электрондық пошта бар ма?',
 'Иә, орталықтың email-і: rehabilcenter@mail.kz. Барлық сұрақтар бойынша осы поштаға жазуға болады.',
 ARRAY['email', 'email', 'почта', 'пошта', 'электронная', 'электрондық', 'написать', 'жазу', 'mail', 'бар', 'есть']),

('contacts',
 'Как добраться до центра?',
 'До центра можно добраться: на автобусах №5 и №12 (остановка " Жусупова"), на такси, на личном транспорте (есть бесплатная парковка). Подробная схема проезда на сайте в разделе "Контакты".',
 'Орталыққа қалай жетуге болады?',
 'Орталыққа мына жолдармен жетуге болады: №5 және №12 автобустармен ("Жүсіпов саябағы" аялдамасы), таксимен, жеке көлікпен (тегін тұрақ бар). Жеткілікті схема сайттың "Байланыс" бөлімінде.',
 ARRAY['добраться', 'жету', 'проезд', 'жол', 'как', 'қалай', 'доехать', 'автобус', 'автобус', 'транспорт', 'көлік', 'парковка', 'тұрақ']);

-- Категория: Стоимость
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('pricing',
 'Сколько стоят услуги?',
 'Стоимость услуг зависит от вида реабилитации и программы лечения. Многие услуги предоставляются бесплатно по направлению врача в рамках ОСМС. Для уточнения цен на платные услуги свяжитесь с регистратурой по телефону +7 (7182) 55-44-33.',
 'Қызметтер қанша тұрады?',
 'Қызмет құны оңалту түрі мен ем бағдарламасына байланысты. Көптеген қызметтер МСМС аясында дәрігердің жолдамасы бойынша тегін көрсетіледі. Ақылы қызметтердің бағасын нақтылау үшін +7 (7182) 55-44-33 телефоны арқылы тіркеу бөліміне хабарласыңыз.',
 ARRAY['цена', 'баға', 'стоимость', 'құн', 'сколько', 'қанша', 'стоит', 'тұрады', 'оплата', 'төлем', 'деньги', 'ақша', 'бесплатно', 'тегін']),

('pricing',
 'Есть ли бесплатные услуги?',
 'Да, многие услуги предоставляются бесплатно по направлению от участкового педиатра или узкого специалиста в рамках ОСМС. Необходимо иметь при себе медицинскую карту и результаты обследований.',
 'Тегін қызметтер бар ма?',
 'Иә, көптеген қызметтер МСМС аясында учаскелік педиатрдың немесе тар маманның жолдамасы бойынша тегін көрсетіледі. Медициналық карта және тексеру нәтижелері болуы қажет.',
 ARRAY['бесплатно', 'тегін', 'без', 'оплаты', 'төлемсіз', 'направление', 'жолдама', 'врач', 'дәрігер', 'педиатр', 'педиатр', 'осмс', 'мсмс', 'бар', 'есть']),

('pricing',
 'Какие документы нужны для бесплатного приёма?',
 'Для бесплатного приёма необходимо: 1) Направление от врача, 2) Медицинская карта ребёнка (форма 026/у), 3) Результаты анализов и обследований (если есть), 4) Свидетельство о рождении ребёнка, 5) Документ, удостоверяющий личность родителя, 6) Полис ОСМС.',
 'Тегін қабылдау үшін қандай құжаттар қажет?',
 'Тегін қабылдау үшін қажет: 1) Дәрігердің жолдамасы, 2) Баланың медициналық картасы (026/у нысаны), 3) Талдаулар мен тексерулердің нәтижелері (болса), 4) Баланың туу туралы куәлігі, 5) Ата-ананың жеке куәлігі, 6) МСМС полисі.',
 ARRAY['документы', 'құжаттар', 'нужны', 'қажет', 'что', 'не', 'қандай', 'принести', 'направление', 'жолдама', 'карта', 'карта', 'бесплатно', 'тегін']);

-- Категория: Возраст и показания
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('age',
 'С какого возраста принимаете детей?',
 'Центр принимает детей от 3 месяцев до 18 лет. Точный возраст зависит от диагноза и программы реабилитации. Младенцев принимаем только с родителями.',
 'Қанша жастан балаларды қабылдайсыздар?',
 'Орталық 3 айлық нәрестелерден бастап 18 жасқа дейінгі балаларды қабылдайды. Нақты жас диагноз бен оңалту бағдарламасына байланысты. Нәрестелерді тек ата-аналармен бірге қабылдаймыз.',
 ARRAY['возраст', 'жас', 'лет', 'жыл', 'месяцев', 'ай', 'детей', 'балалар', 'принимаете', 'қабылдайсыздар', 'малыши', 'нәресте']),

('age',
 'Какие заболевания лечите?',
 'Центр специализируется на реабилитации детей с: ДЦП (детский церебральный паралич), задержкой психоречевого развития (ЗПРР), аутизмом (РАС), неврологическими заболеваниями, нарушениями опорно-двигательного аппарата, последствиями травм, генетическими синдромами, нарушениями слуха и речи.',
 'Қандай аурулар мен жұмыс істейсіздер?',
 'Орталық мына аурулары бар балаларды оңалтуға маманданған: БЦС (балалардың церебралды сал ауруы), психосөйлеу дамуының кешігуі (ПСДК), аутизм (РАС), неврологиялық аурулар, тірек-қимыл аппараты бұзылыстары, жарақат салдары, генетикалық синдромдар, есту және сөйлеу бұзылыстары.',
 ARRAY['заболевания', 'аурулар', 'диагнозы', 'диагноз', 'дцп', 'бцс', 'аутизм', 'аутизм', 'зпрр', 'псдк', 'неврология', 'неврология', 'лечите', 'ем', 'помогаете', 'көмектесесіздер']),

('age',
 'Принимаете ли детей с ДЦП?',
 'Да, реабилитация детей с ДЦП - одно из основных направлений работы центра. Проводится комплексная программа: ЛФК, массаж, физиотерапия, занятия с психологом и логопедом, медикаментозная поддержка.',
 'БЦС бар балаларды қабылдайсыздар ма?',
 'Иә, БЦС бар балаларды оңалту - орталықтың негізгі жұмыс бағыттарының бірі. Кешенді бағдарлама өткізіледі: ЕДШ, массаж, физиотерапия, психолог пен логопедпен сабақтар, медикаменттік қолдау.',
 ARRAY['дцп', 'бцс', 'церебральный', 'церебралды', 'паралич', 'сал', 'принимаете', 'қабылдайсыздар', 'помогаете', 'көмектесесіздер']),

('age',
 'Работаете ли с аутистами?',
 'Да, в центре есть специализированные программы для детей с расстройствами аутистического спектра (РАС). Проводятся занятия с дефектологом, психологом, логопедом, АВА-терапия, сенсорная интеграция.',
 'Аутистермен жұмыс істейсіздер ме?',
 'Иә, орталықта аутистік спектр бұзылыстары (АСБ) бар балаларға арналған мамандандырылған бағдарламалар бар. Дефектолог, психолог, логопедпен сабақтар, АВА-терапия, сенсорлық интеграция өткізіледі.',
 ARRAY['аутизм', 'аутизм', 'аутисты', 'аутист', 'рас', 'асб', 'расстройство', 'бұзылыс', 'спектр', 'спектр', 'работаете', 'істейсіздер']);

-- Категория: Длительность и курсы
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('duration',
 'Сколько длится курс реабилитации?',
 'Курс реабилитации обычно составляет от 10 до 21 дня в зависимости от диагноза и программы. Точную длительность определяет врач после осмотра ребёнка и изучения медицинских документов.',
 'Оңалту курсы қанша уақытқа созылады?',
 'Оңалту курсы диагноз бен бағдарламаға байланысты әдетте 10-нан 21 күнге дейін болады. Нақты ұзақтықты дәрігер баланы қарағаннан және медициналық құжаттарды зерттегеннен кейін анықтайды.',
 ARRAY['курс', 'курс', 'длительность', 'ұзақтық', 'сколько', 'қанша', 'дней', 'күн', 'времени', 'уақыт', 'продолжительность', 'созылады']),

('duration',
 'Как часто нужно проходить реабилитацию?',
 'Рекомендуется проходить курсы реабилитации 2-4 раза в год. Конкретные сроки зависят от состояния ребёнка, динамики улучшений и рекомендаций лечащего врача.',
 'Оңалтуды қанша рет өту керек?',
 'Жылына 2-4 рет оңалту курстарын өту ұсынылады. Нақты мерзімдер баланың жағдайына, жақсару динамикасына және емдеуші дәрігердің ұсынымдарына байланысты.',
 ARRAY['часто', 'жиі', 'рет', 'повторять', 'қайталау', 'курсы', 'курстар', 'год', 'жыл', 'раз', 'регулярность', 'үнемі']),

('duration',
 'Можно ли лежать с ребёнком?',
 'Да, родители могут находиться с ребёнком в течение всего курса реабилитации. Для родителей с детьми предусмотрены комфортные палаты с необходимым оборудованием.',
 'Баламен бірге жатуға бола ма?',
 'Иә, ата-аналар оңалтудың бүкіл курсы бойы баламен бірге бола алады. Балалары бар ата-аналар үшін қажетті жабдықтармен жабдықталған жайлы палаталар қарастырылған.',
 ARRAY['лежать', 'жату', 'родители', 'ата-аналар', 'мама', 'ана', 'папа', 'әке', 'вместе', 'бірге', 'находиться', 'болу']);

-- Категория: Дополнительная информация
INSERT INTO chatbot_knowledge (category, question_ru, answer_ru, question_kz, answer_kz, keywords) VALUES
('additional',
 'Есть ли условия для проживания?',
 'В центре есть комфортабельный стационар с палатами на 2-4 человека. Палаты оборудованы всем необходимым: кровати, тумбочки, санузел, телевизор. Предоставляется трёхразовое питание.',
 'Тұру үшін жағдай бар ма?',
 'Орталықта 2-4 адамға арналған палаталары бар жайлы стационар бар. Палаталар барлық қажеттімен жабдықталған: төсектер, тумбочкалар, дәретхана, теледидар. Күніне үш рет тамақ беріледі.',
 ARRAY['проживание', 'тұру', 'палаты', 'палата', 'условия', 'жағдай', 'ночевать', 'түнеу', 'спать', 'ұйықтау', 'стационар', 'стационар', 'бар', 'есть']),

('additional',
 'Нужна ли предварительная диагностика?',
'Желательно иметь результаты обследований и заключения специалистов (невролога, ортопеда и др.). Если их нет, первичную диагностику можно пройти в центре у наших специалистов.',
'Алдын ала диагностика қажет пе?',
'Тексерулердің нәтижелері мен мамандардың (невролог, ортопед және т.б.) қорытындылары болғаны жөн. Егер олар болмаса, біздің мамандарда орталықта алғашқы диагностикадан өтуге болады.',
ARRAY['диагностика', 'диагностика', 'обследование', 'тексеру', 'анализы', 'талдау', 'узи', 'ұзи', 'мрт', 'мрт', 'нужны', 'қажет', 'необходимо', 'керек']),('additional',
'Работаете ли вы с иностранными пациентами?',
'Да, центр принимает детей из других регионов Казахстана и иностранных граждан. Необходимо заранее связаться с регистратурой для уточнения деталей и записи.',
'Шетелдік пациенттермен жұмыс істейсіздер ме?',
'Иә, орталық Қазақстанның басқа өңірлерінен және шетелдік азаматтардан балаларды қабылдайды. Мәліметтерді нақтылау және жазылу үшін тіркеу бөліміне алдын ала хабарласу қажет.',
ARRAY['иностранцы', 'шетелдік', 'другие', 'басқа', 'регионы', 'өңірлер', 'приезжие', 'келгендер', 'гости', 'қонақтар', 'работаете', 'істейсіздер']),('additional',
'Можно ли получить консультацию онлайн?',
'Да, возможна первичная онлайн-консультация специалистов по видеосвязи. Для записи на онлайн-консультацию звоните по телефону +7 (7182) 55-44-33 или пишите на email: rehabilcenter@mail.kz.',
'Онлайн консультация алуға бола ма?',
'Иә, мамандардың бейнебайланыс арқылы алғашқы онлайн-консультациясы мүмкін. Онлайн-консультацияға жазылу үшін +7 (7182) 55-44-33 телефонына телефон шалыңыз немесе rehabilcenter@mail.kz поштасына жазыңыз.',
ARRAY['онлайн', 'онлайн', 'консультация', 'консультация', 'дистанционно', 'қашықтықтан', 'интернет', 'интернет', 'видео', 'бейне', 'можно', 'бола', 'ма']);-- Создаём функцию поиска с поддержкой двух языков
CREATE OR REPLACE FUNCTION search_chatbot_answer(user_message TEXT, lang TEXT DEFAULT 'ru')
RETURNS JSON AS $$
DECLARE
result_record RECORD;
keywords_array TEXT[];
BEGIN
-- Извлекаем ключевые слова (слова длиннее 2 символов)
SELECT ARRAY_AGG(DISTINCT lower(word)) INTO keywords_array
FROM (
SELECT word
FROM regexp_split_to_table(
regexp_replace(user_message, '[^\wа-яёЁәіңғүұқөһӘІҢҒҮҰҚӨҺ\s]', '', 'g'),
'\s+'
) AS word
WHERE length(word) > 2
) words;-- Если нет ключевых слов
IF keywords_array IS NULL OR array_length(keywords_array, 1) = 0 THEN
IF lang = 'kz' THEN
RETURN json_build_object(
'answer', 'Кешіріңіз, сұрақты түсіну мүмкін болмады. Басқаша тұжырымдап көріңіз.',
'source', 'error'
);
ELSE
RETURN json_build_object(
'answer', 'Извините, не удалось понять вопрос. Попробуйте переформулировать.',
'source', 'error'
);
END IF;
END IF;-- Ищем совпадение по ключевым словам
IF lang = 'kz' THEN
SELECT answer_kz, 'knowledge_base' as source INTO result_record
FROM chatbot_knowledge
WHERE keywords && keywords_array
ORDER BY (
SELECT count()
FROM unnest(chatbot_knowledge.keywords) k
WHERE k = ANY(keywords_array)
) DESC
LIMIT 1;
ELSE
SELECT answer_ru, 'knowledge_base' as source INTO result_record
FROM chatbot_knowledge
WHERE keywords && keywords_array
ORDER BY (
SELECT count()
FROM unnest(chatbot_knowledge.keywords) k
WHERE k = ANY(keywords_array)
) DESC
LIMIT 1;
END IF;-- Если нашли ответ
IF lang = 'kz' AND result_record IS NOT NULL THEN
RETURN json_build_object(
'answer', result_record.answer_kz,
'source', 'knowledge_base'
);
ELSIF result_record IS NOT NULL THEN
RETURN json_build_object(
'answer', result_record.answer_ru,
'source', 'knowledge_base'
);
ELSE
-- Fallback
IF lang = 'kz' THEN
RETURN json_build_object(
'answer', 'Кешіріңіз, сұрағыңыз бойынша ақпарат таба алмадым. Бізбен байланысыңыз: +7 (7182) 55-44-33',
'source', 'fallback'
);
ELSE
RETURN json_build_object(
'answer', 'Извините, я не нашёл информации по вашему вопросу. Свяжитесь с нами: +7 (7182) 55-44-33',
'source', 'fallback'
);
END IF;
END IF;
END;
$$ LANGUAGE plpgsql;-- Даём публичный доступ к функции
GRANT EXECUTE ON FUNCTION search_chatbot_answer(TEXT, TEXT) TO anon, authenticated;